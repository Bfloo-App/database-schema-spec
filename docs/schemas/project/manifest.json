{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Snapshot Manifest",
  "description": "Schema for .bfloo/<schema>/manifest.yml - snapshot registry tracking all schema versions with their metadata, parent relationships, sync state, and content hashes. Uses a map structure keyed by snapshot ID for git merge-friendliness.",
  "type": "object",
  "properties": {
    "snapshots": {
      "type": "object",
      "description": "Map of snapshots keyed by ID (UUID or local-<UUID> for unpushed snapshots)",
      "propertyNames": {
        "pattern": "^([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}|local-[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})$",
        "description": "Remote UUID or local-<UUID> for unpushed snapshots"
      },
      "additionalProperties": {
        "$ref": "#/$defs/snapshot"
      },
      "minProperties": 1
    }
  },
  "required": ["snapshots"],
  "additionalProperties": false,
  "$defs": {
    "snapshot": {
      "type": "object",
      "description": "A snapshot representing a database schema at a point in time",
      "properties": {
        "label": {
          "type": "string",
          "description": "Human-readable version label (unique within schema)",
          "minLength": 1,
          "maxLength": 64,
          "examples": ["v1.0.0", "v2.0.0", "v2.1.0-hotfix", "v1.0.1-experiment"]
        },
        "parent-id": {
          "type": ["string", "null"],
          "description": "ID of parent snapshot (UUID or local-<UUID>). Null for initial snapshot. Parent must have status 'done'.",
          "pattern": "^([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}|local-[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})$"
        },
        "status": {
          "type": "string",
          "description": "Snapshot status. 'draft' snapshots are editable but cannot be parents. 'done' snapshots are immutable and can be parents. Snapshots automatically become 'done' when they have children.",
          "enum": ["draft", "done"],
          "default": "draft"
        },
        "database-version": {
          "type": "string",
          "description": "Database engine version for this snapshot (e.g., 'v15.0', 'v16.0')",
          "pattern": "^v[0-9]+\\.[0-9]+(\\.[0-9]+)?$",
          "examples": ["v15.0", "v16.0", "v15.4.1"]
        },
        "created-at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when snapshot was created"
        },
        "file": {
          "type": "string",
          "description": "Filename in .bfloo/<schema>/ directory, or 'current' if this is the active snapshot (lives at working path defined in config)",
          "pattern": "^(current|[0-9]{4}-[0-9]{2}-[0-9]{2}_[a-zA-Z0-9._-]+\\.yml)$",
          "examples": ["current", "2024-01-15_v1.0.0.yml", "2024-03-20_v2.0.0.yml"]
        },
        "content-hash": {
          "type": "string",
          "description": "SHA-256 hash of snapshot file content for integrity verification and drift detection",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "examples": ["sha256:a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2"]
        },
        "sync-state": {
          "type": "string",
          "description": "Synchronization state with remote web app. 'synced' = exists on remote. 'local-only' = created locally, never pushed. 'orphaned' = was synced but ID no longer exists on remote.",
          "enum": ["synced", "local-only", "orphaned"],
          "default": "local-only"
        },
        "synced-at": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "ISO 8601 timestamp when snapshot was last synced to remote. Null if never synced.",
          "examples": ["2024-01-15T10:35:00Z", null]
        }
      },
      "required": ["label", "parent-id", "status", "database-version", "created-at", "file", "content-hash", "sync-state"],
      "additionalProperties": false
    }
  }
}

{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PostgreSQL Configuration",
  "description": "Schema for PostgreSQL-specific configuration including environment connection parameters. All connection parameters follow the official PostgreSQL libpq specification.",
  "type": "object",
  "properties": {
    "environments": {
      "type": "object",
      "description": "Environment-specific connection configurations (e.g., development, staging, production)",
      "additionalProperties": {
        "$ref": "#/$defs/environment"
      },
      "minProperties": 1
    }
  },
  "required": ["environments"],
  "additionalProperties": false,
  "$defs": {
    "environment": {
      "type": "object",
      "description": "Connection configuration for a single environment",
      "properties": {
        "host": {
          "type": "string",
          "description": "Name of host to connect to. If starts with '/', it specifies Unix-domain socket directory. A comma-separated list is also accepted for multiple hosts.",
          "minLength": 1,
          "maxLength": 1024,
          "examples": ["localhost", "db.example.com", "/var/run/postgresql", "host1,host2,host3"]
        },
        "hostaddr": {
          "type": "string",
          "description": "Numeric IP address of host to connect to (IPv4 or IPv6). Bypasses DNS lookup. Can be comma-separated list matching host entries.",
          "minLength": 1,
          "maxLength": 1024,
          "examples": ["127.0.0.1", "192.168.1.100", "::1", "2001:db8::1234"]
        },
        "port": {
          "type": "integer",
          "description": "Port number to connect to at the server host. Default is 5432.",
          "minimum": 1,
          "maximum": 65535,
          "default": 5432,
          "examples": [5432, 5433, 6432]
        },
        "dbname": {
          "type": "string",
          "description": "The database name. Supports environment variable interpolation with ${VAR_NAME} syntax.",
          "minLength": 1,
          "maxLength": 63,
          "pattern": "^[a-zA-Z_][a-zA-Z0-9_$]*$|^\\$\\{[A-Z_][A-Z0-9_]*\\}$"
        },
        "user": {
          "type": "string",
          "description": "PostgreSQL user name to connect as. Supports environment variable interpolation with ${VAR_NAME} syntax.",
          "minLength": 1,
          "maxLength": 63
        },
        "password": {
          "type": "string",
          "description": "Password for authentication. IMPORTANT: Use environment variable interpolation (${VAR_NAME}) - never store plaintext passwords.",
          "minLength": 1
        },
        "passfile": {
          "type": "string",
          "description": "Path to password file (~/.pgpass format). Defaults to ~/.pgpass on Unix.",
          "minLength": 1
        },
        "require_auth": {
          "type": "string",
          "description": "Authentication method required from server. Comma-separated list allowed. Prefix with '!' to negate.",
          "enum": [
            "password",
            "md5",
            "gss",
            "sspi",
            "scram-sha-256",
            "none",
            "!password",
            "!md5",
            "!gss",
            "!sspi",
            "!scram-sha-256",
            "!none"
          ]
        },
        "channel_binding": {
          "type": "string",
          "description": "Controls client's use of channel binding for SCRAM authentication.",
          "enum": ["disable", "prefer", "require"],
          "default": "prefer"
        },
        "connect_timeout": {
          "type": "integer",
          "description": "Maximum time to wait while connecting, in seconds. Zero means wait indefinitely.",
          "minimum": 0,
          "maximum": 2147483647,
          "default": 0
        },
        "client_encoding": {
          "type": "string",
          "description": "Client encoding for the connection. Use 'auto' to detect from locale.",
          "minLength": 1,
          "examples": ["UTF8", "LATIN1", "auto"]
        },
        "options": {
          "type": "string",
          "description": "Command-line options to send to the server at connection start (e.g., '-c search_path=myschema').",
          "maxLength": 1024
        },
        "application_name": {
          "type": "string",
          "description": "Application name for the connection (visible in pg_stat_activity).",
          "maxLength": 63
        },
        "keepalives": {
          "type": "integer",
          "description": "Controls whether client-side TCP keepalives are used. 1=on, 0=off.",
          "enum": [0, 1],
          "default": 1
        },
        "keepalives_idle": {
          "type": "integer",
          "description": "Seconds of inactivity before sending a TCP keepalive. Zero uses system default.",
          "minimum": 0,
          "maximum": 2147483647,
          "default": 0
        },
        "keepalives_interval": {
          "type": "integer",
          "description": "Seconds between TCP keepalive retransmits. Zero uses system default.",
          "minimum": 0,
          "maximum": 2147483647,
          "default": 0
        },
        "keepalives_count": {
          "type": "integer",
          "description": "Maximum number of TCP keepalive retransmits before connection is dead. Zero uses system default.",
          "minimum": 0,
          "maximum": 2147483647,
          "default": 0
        },
        "tcp_user_timeout": {
          "type": "integer",
          "description": "Milliseconds that transmitted data may remain unacknowledged before connection is closed. Zero uses system default.",
          "minimum": 0,
          "maximum": 2147483647,
          "default": 0
        },
        "sslmode": {
          "type": "string",
          "description": "Determines SSL connection negotiation priority with the server.",
          "enum": ["disable", "allow", "prefer", "require", "verify-ca", "verify-full"],
          "default": "prefer"
        },
        "sslnegotiation": {
          "type": "string",
          "description": "Controls how SSL encryption is negotiated. 'postgres' uses PostgreSQL protocol negotiation, 'direct' starts SSL handshake immediately.",
          "enum": ["postgres", "direct"],
          "default": "postgres"
        },
        "sslcompression": {
          "type": "integer",
          "description": "Enable SSL compression. 1=on, 0=off. Compression is considered insecure and disabled by default.",
          "enum": [0, 1],
          "default": 0
        },
        "sslcert": {
          "type": "string",
          "description": "Path to client SSL certificate file. Default is ~/.postgresql/postgresql.crt.",
          "minLength": 1
        },
        "sslkey": {
          "type": "string",
          "description": "Path to client SSL private key file. Default is ~/.postgresql/postgresql.key.",
          "minLength": 1
        },
        "sslpassword": {
          "type": "string",
          "description": "Password for encrypted SSL private key. Use environment variable interpolation (${VAR_NAME}).",
          "minLength": 1
        },
        "sslcertmode": {
          "type": "string",
          "description": "Whether a client certificate may be sent to the server.",
          "enum": ["disable", "allow", "require"],
          "default": "allow"
        },
        "sslrootcert": {
          "type": "string",
          "description": "Path to SSL CA certificate file. Use 'system' for system-wide trusted CAs. Default is ~/.postgresql/root.crt.",
          "minLength": 1,
          "examples": ["~/.postgresql/root.crt", "system", "/etc/ssl/certs/ca-certificates.crt"]
        },
        "sslcrl": {
          "type": "string",
          "description": "Path to SSL certificate revocation list file.",
          "minLength": 1
        },
        "sslcrldir": {
          "type": "string",
          "description": "Directory containing SSL certificate revocation list files (must be prepared with openssl rehash).",
          "minLength": 1
        },
        "sslsni": {
          "type": "integer",
          "description": "Enable Server Name Indication (SNI) on SSL connections. 1=on, 0=off.",
          "enum": [0, 1],
          "default": 1
        },
        "ssl_min_protocol_version": {
          "type": "string",
          "description": "Minimum SSL/TLS protocol version to allow.",
          "enum": ["TLSv1", "TLSv1.1", "TLSv1.2", "TLSv1.3"],
          "default": "TLSv1.2"
        },
        "ssl_max_protocol_version": {
          "type": "string",
          "description": "Maximum SSL/TLS protocol version to allow. If not set, uses backend maximum.",
          "enum": ["TLSv1", "TLSv1.1", "TLSv1.2", "TLSv1.3"]
        },
        "gssencmode": {
          "type": "string",
          "description": "Controls GSS encryption negotiation with the server.",
          "enum": ["disable", "prefer", "require"],
          "default": "prefer"
        },
        "krbsrvname": {
          "type": "string",
          "description": "Kerberos service name for GSSAPI authentication. Default is 'postgres'.",
          "minLength": 1,
          "default": "postgres"
        },
        "gsslib": {
          "type": "string",
          "description": "GSS library to use for GSSAPI authentication (Windows only).",
          "enum": ["gssapi"]
        },
        "gssdelegation": {
          "type": "integer",
          "description": "Forward GSS credentials to the server. 1=on, 0=off.",
          "enum": [0, 1],
          "default": 0
        },
        "service": {
          "type": "string",
          "description": "Service name in pg_service.conf for additional connection parameters.",
          "minLength": 1,
          "maxLength": 64
        },
        "target_session_attrs": {
          "type": "string",
          "description": "Session properties required for connection to be acceptable. Useful with multiple hosts.",
          "enum": ["any", "read-write", "read-only", "primary", "standby", "prefer-standby"],
          "default": "any"
        },
        "load_balance_hosts": {
          "type": "string",
          "description": "Controls the order in which multiple hosts are tried.",
          "enum": ["disable", "random"],
          "default": "disable"
        }
      },
      "required": ["host", "dbname", "user"],
      "additionalProperties": false,
      "allOf": [
        {
          "if": {
            "properties": {
              "sslnegotiation": { "const": "direct" }
            },
            "required": ["sslnegotiation"]
          },
          "then": {
            "properties": {
              "sslmode": {
                "enum": ["require", "verify-ca", "verify-full"]
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "sslrootcert": { "const": "system" }
            },
            "required": ["sslrootcert"]
          },
          "then": {
            "properties": {
              "sslmode": {
                "enum": ["verify-full"],
                "default": "verify-full"
              }
            }
          }
        }
      ]
    }
  }
}
